<!DOCTYPE html>
     <html lang="en">
     <head>
         <meta charset="UTF-8">
         <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <title>Network Latency Monitor - AI Enhanced</title>
         <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
         <style>
             * {
                 margin: 0;
                 padding: 0;
                 box-sizing: border-box;
             }

             :root {
                 --bg-primary: #0f172a;
                 --bg-secondary: #1e293b;
                 --bg-card: #334155;
                 --text-primary: #f1f5f9;
                 --text-secondary: #cbd5e1;
                 --accent: #3b82f6;
                 --success: #10b981;
                 --warning: #f59e0b;
                 --danger: #ef4444;
                 --border: #475569;
                 --mcp-accent: #8b5cf6; /* New MCP AI color */
                 --ai-glow: #a855f7;
             }

             body {
                 font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                 background: var(--bg-primary);
                 color: var(--text-primary);
                 line-height: 1.6;
             }

             .container {
                 max-width: 1600px; /* Wider for AI panel */
                 margin: 0 auto;
                 padding: 20px;
             }

             .header {
                 display: flex;
                 justify-content: space-between;
                 align-items: center;
                 margin-bottom: 30px;
                 flex-wrap: wrap;
                 gap: 20px;
             }

             h1 {
                 font-size: 2rem;
                 font-weight: 700;
                 display: flex;
                 align-items: center;
                 gap: 10px;
             }

             .ai-badge {
                 background: linear-gradient(135deg, var(--mcp-accent), var(--ai-glow));
                 color: white;
                 padding: 4px 12px;
                 border-radius: 20px;
                 font-size: 0.7rem;
                 font-weight: 600;
                 text-transform: uppercase;
                 letter-spacing: 0.5px;
                 animation: glow 2s ease-in-out infinite alternate;
             }

             @keyframes glow {
                 from { box-shadow: 0 0 5px var(--mcp-accent); }
                 to { box-shadow: 0 0 15px var(--ai-glow), 0 0 25px var(--mcp-accent); }
             }

             .status-bar {
                 display: flex;
                 align-items: center;
                 gap: 20px;
                 flex-wrap: wrap;
             }

             .last-update {
                 color: var(--text-secondary);
                 font-size: 0.9rem;
             }

             .toggle-btn {
                 background: var(--bg-card);
                 border: 1px solid var(--border);
                 color: var(--text-primary);
                 padding: 8px 16px;
                 border-radius: 8px;
                 cursor: pointer;
                 transition: all 0.3s ease;
                 display: flex;
                 align-items: center;
                 gap: 8px;
             }

             .toggle-btn:hover {
                 background: var(--border);
             }

             .toggle-btn.active {
                 background: var(--accent);
                 border-color: var(--accent);
             }

             .toggle-btn.ai-mode {
                 background: linear-gradient(135deg, var(--mcp-accent), var(--ai-glow));
                 border-color: var(--mcp-accent);
             }

             .toggle-btn.ai-mode:hover {
                 background: linear-gradient(135deg, var(--ai-glow), var(--mcp-accent));
             }

             /* Main Layout - Now with sidebar for AI */
             .main-layout {
                 display: grid;
                 grid-template-columns: 1fr 400px; /* Main content + AI sidebar */
                 gap: 30px;
                 margin-bottom: 30px;
             }

             .main-content {
                 min-width: 0; /* Prevents overflow */
             }

             .ai-sidebar {
                 background: var(--bg-secondary);
                 border: 1px solid var(--border);
                 border-radius: 12px;
                 padding: 20px;
                 height: fit-content;
                 position: sticky;
                 top: 20px;
             }

             .ai-sidebar.hidden {
                 display: none;
             }

             /* Responsive - Stack on mobile */
             @media (max-width: 1200px) {
                 .main-layout {
                     grid-template-columns: 1fr;
                 }

                 .ai-sidebar {
                     order: -1; /* Show AI insights first on mobile */
                 }
             }

             .stats-grid {
                 display: grid;
                 grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                 gap: 20px;
                 margin-bottom: 30px;
             }

             .stat-card {
                 background: var(--bg-secondary);
                 border: 1px solid var(--border);
                 border-radius: 12px;
                 padding: 20px;
                 text-align: center;
                 transition: all 0.3s ease;
             }

             .stat-card:hover {
                 border-color: var(--accent);
                 transform: translateY(-2px);
             }

             .stat-number {
                 font-size: 2.5rem;
                 font-weight: 700;
                 margin-bottom: 5px;
             }

             .stat-label {
                 color: var(--text-secondary);
                 font-size: 0.9rem;
                 font-weight: 500;
             }

             .stat-card.online .stat-number { color: var(--success); }
             .stat-card.offline .stat-number { color: var(--danger); }
             .stat-card.latency .stat-number { color: var(--accent); }

             /* AI Insights Panel Styles */
             .ai-panel-header {
                 display: flex;
                 align-items: center;
                 gap: 10px;
                 margin-bottom: 20px;
                 padding-bottom: 15px;
                 border-bottom: 2px solid var(--mcp-accent);
             }

             .ai-panel-header h3 {
                 color: var(--mcp-accent);
                 font-size: 1.2rem;
             }

             .ai-score-gauge {
                 background: var(--bg-card);
                 border-radius: 12px;
                 padding: 20px;
                 text-align: center;
                 margin-bottom: 20px;
                 position: relative;
                 overflow: hidden;
             }

             .ai-score-gauge::before {
                 content: '';
                 position: absolute;
                 top: 0;
                 left: 0;
                 right: 0;
                 bottom: 0;
                 background: linear-gradient(135deg, var(--mcp-accent)20, transparent);
                 z-index: 0;
             }

             .ai-score-gauge > * {
                 position: relative;
                 z-index: 1;
             }

             .score-number {
                 font-size: 3rem;
                 font-weight: 800;
                 background: linear-gradient(135deg, var(--mcp-accent), var(--ai-glow));
                 -webkit-background-clip: text;
                 -webkit-text-fill-color: transparent;
                 background-clip: text;
             }

             .score-label {
                 font-size: 0.9rem;
                 color: var(--text-secondary);
                 margin-bottom: 10px;
             }

             .score-status {
                 padding: 6px 14px;
                 border-radius: 20px;
                 font-size: 0.8rem;
                 font-weight: 600;
                 text-transform: uppercase;
             }

             .score-status.excellent {
                 background: var(--success);
                 color: white;
             }
             .score-status.good {
                 background: var(--accent);
                 color: white;
             }
             .score-status.warning {
                 background: var(--warning);
                 color: var(--bg-primary);
             }
             .score-status.critical {
                 background: var(--danger);
                 color: white;
             }

             .ai-recommendations {
                 background: var(--bg-card);
                 border-radius: 12px;
                 padding: 20px;
                 margin-bottom: 20px;
             }

             .ai-recommendations h4 {
                 color: var(--ai-glow);
                 margin-bottom: 15px;
                 display: flex;
                 align-items: center;
                 gap: 8px;
             }

             .recommendation-item {
                 background: var(--bg-primary);
                 border: 1px solid var(--border);
                 border-radius: 8px;
                 padding: 12px;
                 margin-bottom: 10px;
                 font-size: 0.9rem;
                 line-height: 1.5;
             }

             .recommendation-item:last-child {
                 margin-bottom: 0;
             }

             .platform-status {
                 background: var(--bg-card);
                 border-radius: 12px;
                 padding: 20px;
             }

             .platform-status h4 {
                 color: var(--success);
                 margin-bottom: 15px;
                 display: flex;
                 align-items: center;
                 gap: 8px;
             }

             .platform-item {
                 display: flex;
                 justify-content: space-between;
                 align-items: center;
                 padding: 8px 0;
                 border-bottom: 1px solid var(--border);
             }

             .platform-item:last-child {
                 border-bottom: none;
             }

             .platform-name {
                 font-weight: 500;
             }

             .platform-url {
                 color: var(--text-secondary);
                 font-size: 0.8rem;
             }

             .platform-link {
                 background: var(--accent);
                 color: white;
                 padding: 4px 8px;
                 border-radius: 6px;
                 text-decoration: none;
                 font-size: 0.8rem;
                 transition: background-color 0.3s ease;
             }

             .platform-link:hover {
                 background: var(--mcp-accent);
             }

             /* Enhanced Device Cards */
             .devices-grid {
                 display: grid;
                 grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
                 gap: 20px;
             }

             .device-card {
                 background: var(--bg-secondary);
                 border: 1px solid var(--border);
                 border-radius: 12px;
                 padding: 20px;
                 transition: all 0.3s ease;
                 position: relative;
             }

             .device-card:hover {
                 border-color: var(--accent);
                 transform: translateY(-2px);
                 box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
             }

             .device-card.ai-enhanced {
                 border-color: var(--mcp-accent);
                 background: linear-gradient(135deg, var(--bg-secondary), var(--bg-secondary)f0);
             }

             .device-header {
                 display: flex;
                 justify-content: space-between;
                 align-items: flex-start;
                 margin-bottom: 15px;
             }

             .device-name {
                 font-weight: 600;
                 font-size: 1.1rem;
                 color: var(--text-primary);
             }

             .device-ip {
                 color: var(--text-secondary);
                 font-size: 0.9rem;
                 margin-top: 2px;
             }

             .device-actions {
                 display: flex;
                 gap: 8px;
             }

             .action-btn {
                 background: var(--bg-card);
                 border: 1px solid var(--border);
                 color: var(--text-secondary);
                 padding: 6px 8px;
                 border-radius: 6px;
                 cursor: pointer;
                 font-size: 0.8rem;
                 transition: all 0.3s ease;
             }

             .action-btn:hover {
                 background: var(--border);
                 color: var(--text-primary);
             }

             .action-btn.delete {
                 border-color: var(--danger);
                 color: var(--danger);
             }

             .action-btn.delete:hover {
                 background: var(--danger);
                 color: white;
             }

             .status-indicator {
                 display: flex;
                 align-items: center;
                 gap: 8px;
                 margin-bottom: 15px;
             }

             .status-dot {
                 width: 12px;
                 height: 12px;
                 border-radius: 50%;
                 animation: pulse 2s infinite;
             }

             .status-dot.online {
                 background: var(--success);
             }

             .status-dot.offline {
                 background: var(--danger);
                 animation: none;
             }

             @keyframes pulse {
                 0% { opacity: 1; }
                 50% { opacity: 0.5; }
                 100% { opacity: 1; }
             }

             .latency-display {
                 font-size: 2rem;
                 font-weight: 700;
                 color: var(--accent);
                 margin-bottom: 15px;
             }

             .latency-chart {
                 height: 100px;
                 background: var(--bg-primary);
                 border-radius: 8px;
                 padding: 10px;
                 overflow: hidden;
             }

             .latency-chart svg {
                 width: 100%;
                 height: 100%;
             }

             .sparkline {
                 fill: none;
                 stroke: var(--accent);
                 stroke-width: 2;
                 opacity: 0.8;
             }

             .ai-insights-mini {
                 background: linear-gradient(135deg, var(--mcp-accent)20, transparent);
                 border: 1px solid var(--mcp-accent);
                 border-radius: 8px;
                 padding: 12px;
                 margin-top: 15px;
             }

             .ai-insights-mini h5 {
                 color: var(--mcp-accent);
                 font-size: 0.9rem;
                 margin-bottom: 8px;
                 display: flex;
                 align-items: center;
                 gap: 6px;
             }

             .ai-metric {
                 display: flex;
                 justify-content: space-between;
                 font-size: 0.8rem;
                 margin-bottom: 4px;
             }

             .ai-metric:last-child {
                 margin-bottom: 0;
             }

             /* Add device form styles remain the same */
             .add-device-section {
                 background: var(--bg-secondary);
                 border: 1px solid var(--border);
                 border-radius: 12px;
                 margin-bottom: 30px;
                 overflow: hidden;
                 max-height: 0;
                 transition: all 0.3s ease;
             }

             .add-device-section.active {
                 max-height: 300px;
             }

             .add-device-form {
                 padding: 20px;
             }

             .form-group {
                 margin-bottom: 20px;
             }

             .form-group label {
                 display: block;
                 margin-bottom: 5px;
                 color: var(--text-secondary);
                 font-weight: 500;
             }

             .form-group input {
                 width: 100%;
                 background: var(--bg-primary);
                 border: 1px solid var(--border);
                 color: var(--text-primary);
                 padding: 12px;
                 border-radius: 8px;
                 font-size: 1rem;
             }

             .form-group input:focus {
                 outline: none;
                 border-color: var(--accent);
                 box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
             }

             .form-actions {
                 display: flex;
                 gap: 10px;
             }

             .btn {
                 background: var(--accent);
                 color: white;
                 border: none;
                 padding: 12px 20px;
                 border-radius: 8px;
                 cursor: pointer;
                 font-weight: 500;
                 transition: background-color 0.3s ease;
             }

             .btn:hover {
                 background: var(--mcp-accent);
             }

             .btn-secondary {
                 background: var(--bg-card);
                 color: var(--text-primary);
                 border: 1px solid var(--border);
             }

             .btn-secondary:hover {
                 background: var(--border);
             }

             /* Notification styles remain the same */
             .notification {
                 position: fixed;
                 top: 20px;
                 right: 20px;
                 background: var(--success);
                 color: white;
                 padding: 15px 20px;
                 border-radius: 8px;
                 transform: translateX(100%);
                 transition: transform 0.3s ease;
                 z-index: 1000;
             }

             .notification.show {
                 transform: translateX(0);
             }

             .notification.error {
                 background: var(--danger);
             }

             /* Loading states */
             .loading {
                 opacity: 0.6;
                 pointer-events: none;
             }

             .ai-loading {
                 display: inline-block;
                 width: 16px;
                 height: 16px;
                 border: 2px solid var(--mcp-accent);
                 border-radius: 50%;
                 border-top-color: transparent;
                 animation: spin 1s ease-in-out infinite;
             }

             @keyframes spin {
                 to { transform: rotate(360deg); }
             }
         </style>
     </head>
     <body>
         <div class="container">
             <div class="header">
                 <h1>
                     <i class="fas fa-network-wired"></i>
                     Network Latency Monitor
                     <span class="ai-badge">AI Enhanced</span>
                 </h1>
                 <div class="status-bar">
                     <div class="last-update">
                         Last update: <span id="timestamp">-</span>
                     </div>
                     <button class="toggle-btn ai-mode" id="ai-toggle-btn">
                         <i class="fas fa-brain"></i>
                         AI Insights
                     </button>
                     <button class="toggle-btn active" id="auto-refresh-btn">
                         <i class="fas fa-sync-alt"></i>
                         Auto Refresh
                     </button>
                 </div>
             </div>

             <div class="main-layout">
                 <div class="main-content">
                     <!-- Statistics Grid -->
                     <div class="stats-grid">
                         <div class="stat-card">
                             <div class="stat-number" id="total-devices">0</div>
                             <div class="stat-label">Total Devices</div>
                         </div>
                         <div class="stat-card online">
                             <div class="stat-number" id="online-devices">0</div>
                             <div class="stat-label">Online</div>
                         </div>
                         <div class="stat-card offline">
                             <div class="stat-number" id="offline-devices">0</div>
                             <div class="stat-label">Offline</div>
                         </div>
                         <div class="stat-card latency">
                             <div class="stat-number" id="avg-latency">-</div>
                             <div class="stat-label">Avg Latency (ms)</div>
                         </div>
                     </div>

                     <!-- Add Device Section -->
                     <button class="toggle-btn" onclick="toggleAddDevice()">
                         <i class="fas fa-plus"></i>
                         Add Device
                     </button>

                     <div class="add-device-section" id="add-device-section">
                         <form class="add-device-form" id="device-form">
                             <div class="form-group">
                                 <label for="device-name">Device Name</label>
                                 <input type="text" id="device-name" name="name" required>
                             </div>
                             <div class="form-group">
                                 <label for="device-ip">IP Address</label>
                                 <input type="text" id="device-ip" name="ip" required pattern="^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$">
                             </div>
                             <div class="form-actions">
                                 <button type="submit" class="btn">Add Device</button>
                                 <button type="button" class="btn btn-secondary" onclick="toggleAddDevice()">Cancel</button>
                             </div>
                         </form>
                     </div>

                     <!-- Devices Grid -->
                     <div class="devices-grid" id="devices-container">
                         <!-- Device cards will be populated here -->
                     </div>
                 </div>

                 <!-- AI Sidebar -->
                 <div class="ai-sidebar" id="ai-sidebar">
                     <div class="ai-panel-header">
                         <i class="fas fa-brain"></i>
                         <h3>AI Network Intelligence</h3>
                         <div class="ai-loading" id="ai-loading" style="display: none;"></div>
                     </div>

                     <!-- AI Network Score -->
                     <div class="ai-score-gauge">
                         <div class="score-label">Network Performance Score</div>
                         <div class="score-number" id="ai-score">--</div>
                         <div class="score-status" id="ai-status">Analyzing...</div>
                     </div>

                     <!-- AI Recommendations -->
                     <div class="ai-recommendations">
                         <h4>
                             <i class="fas fa-lightbulb"></i>
                             Smart Recommendations
                         </h4>
                         <div id="ai-recommendations-list">
                             <div class="recommendation-item">
                                 üîç Analyzing network patterns...
                             </div>
                         </div>
                     </div>

                     <!-- Platform Status -->
                     <div class="platform-status">
                         <h4>
                             <i class="fas fa-network-wired"></i>
                             Cyphor Ecosystem
                         </h4>
                         <div id="platform-status-list">
                             <div class="platform-item">
                                 <div>
                                     <div class="platform-name">Discovering platforms...</div>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
         </div>

         <!-- Notification -->
         <div class="notification" id="notification">
             <span id="notification-text">Notification</span>
         </div>

         <script>
             // Global variables
             let autoRefresh = true;
             let aiInsightsEnabled = true;
             let deviceHistory = {};
             let aiData = null;
             let platformData = null;
             const HISTORY_POINTS = 50;

             // MCP Server Configuration - Update this to match your MCP server
             const MCP_SERVER_URL = 'http://192.168.4.154:8080'; // Your MCP server location

             // DOM elements
             const timestampEl = document.getElementById('timestamp');
             const devicesContainer = document.getElementById('devices-container');
             const totalDevicesEl = document.getElementById('total-devices');
             const onlineDevicesEl = document.getElementById('online-devices');
             const offlineDevicesEl = document.getElementById('offline-devices');
             const avgLatencyEl = document.getElementById('avg-latency');
             const autoRefreshBtn = document.getElementById('auto-refresh-btn');
             const aiToggleBtn = document.getElementById('ai-toggle-btn');
             const aiSidebar = document.getElementById('ai-sidebar');
             const aiScoreEl = document.getElementById('ai-score');
             const aiStatusEl = document.getElementById('ai-status');
             const aiRecommendationsEl = document.getElementById('ai-recommendations-list');
             const platformStatusEl = document.getElementById('platform-status-list');
             const aiLoadingEl = document.getElementById('ai-loading');
             const notification = document.getElementById('notification');
             const notificationText = document.getElementById('notification-text');

             // Toggle auto refresh
             autoRefreshBtn.addEventListener('click', () => {
                 autoRefresh = !autoRefresh;
                 autoRefreshBtn.classList.toggle('active');
                 showNotification(autoRefresh ? 'Auto refresh enabled' : 'Auto refresh disabled', 'success');
             });

             // Toggle AI insights
             aiToggleBtn.addEventListener('click', () => {
                 aiInsightsEnabled = !aiInsightsEnabled;
                 aiToggleBtn.classList.toggle('active');
                 aiSidebar.classList.toggle('hidden');
                 showNotification(aiInsightsEnabled ? 'AI insights enabled' : 'AI insights disabled', 'success');
             });

             // Show notification
             function showNotification(message, type = 'success') {
                 notificationText.textContent = message;
                 notification.className = `notification ${type} show`;
                 setTimeout(() => {
                     notification.classList.remove('show');
                 }, 3000);
             }

             // Toggle add device form
             function toggleAddDevice() {
                 const section = document.getElementById('add-device-section');
                 section.classList.toggle('active');
                 if (section.classList.contains('active')) {
                     document.querySelector('.add-device-form input[name="name"]').focus();
                 }
             }

             // Create sparkline chart (enhanced version)
             function createSparkline(data, deviceName) {
                 if (!data || data.length === 0) return '';

                 const width = 350;
                 const height = 100;
                 const padding = 10;

                 const max = Math.max(...data, 100);
                 const min = 0;

                 const xScale = (i) => (i / (data.length - 1)) * (width - 2 * padding) + padding;
                 const yScale = (v) => height - ((v - min) / (max - min)) * (height - 2 * padding) - padding;

                 const points = data.map((v, i) => `${xScale(i)},${yScale(v)}`).join(' ');

                 // Enhanced sparkline with gradient and better styling
                 const avgLatency = data.reduce((a, b) => a + b, 0) / data.length;
                 const strokeColor = avgLatency < 50 ? '#10b981' : avgLatency < 100 ? '#3b82f6' : '#f59e0b';

                 return `
                     <svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
                         <defs>
                             <linearGradient id="gradient-${deviceName}" x1="0%" y1="0%" x2="0%" y2="100%">
                                 <stop offset="0%" style="stop-color:${strokeColor};stop-opacity:0.3" />
                                 <stop offset="100%" style="stop-color:${strokeColor};stop-opacity:0" />
                             </linearGradient>
                         </defs>
                         <polyline class="sparkline" points="${points}" style="stroke: ${strokeColor};" />
                         <polygon points="${points} ${width-padding},${height-padding} ${padding},${height-padding}"
                                  fill="url(#gradient-${deviceName})" />
                     </svg>
                 `;
             }

             // Create AI insights for device
             function createDeviceAIInsights(device, deviceName) {
                 if (!aiData || !aiInsightsEnabled) return '';

                 const history = deviceHistory[deviceName] || [];
                 if (history.length < 5) return ''; // Need some history for AI insights

                 const avgLatency = history.reduce((a, b) => a + b, 0) / history.length;
                 const maxLatency = Math.max(...history);
                 const minLatency = Math.min(...history);
                 const variance = history.reduce((acc, val) => acc + Math.pow(val - avgLatency, 2), 0) / history.length;
                 const jitter = Math.sqrt(variance);

                 const quality = avgLatency < 20 ? 'Excellent' : avgLatency < 50 ? 'Good' : avgLatency < 100 ? 'Fair' : 'Poor';
                 const stability = jitter < 5 ? 'Very Stable' : jitter < 15 ? 'Stable' : jitter < 30 ? 'Moderate' : 'Unstable';

                 return `
                     <div class="ai-insights-mini">
                         <h5><i class="fas fa-brain"></i> AI Analysis</h5>
                         <div class="ai-metric">
                             <span>Quality:</span>
                             <span style="color: ${avgLatency < 50 ? 'var(--success)' : avgLatency < 100 ? 'var(--accent)' : 'var(--warning)'}">${quality}</span>
                         </div>
                         <div class="ai-metric">
                             <span>Stability:</span>
                             <span style="color: ${jitter < 15 ? 'var(--success)' : jitter < 30 ? 'var(--accent)' : 'var(--warning)'}">${stability}</span>
                         </div>
                         <div class="ai-metric">
                             <span>Jitter:</span>
                             <span>${jitter.toFixed(1)}ms</span>
                         </div>
                         <div class="ai-metric">
                             <span>Range:</span>
                             <span>${minLatency.toFixed(1)} - ${maxLatency.toFixed(1)}ms</span>
                         </div>
                     </div>
                 `;
             }

             // Fetch AI insights from MCP server
             async function fetchAIInsights() {
                 if (!aiInsightsEnabled) return;

                 aiLoadingEl.style.display = 'inline-block';

                 try {
                     // Note: In a real implementation, you'd call the MCP server
                     // For now, we'll simulate the AI analysis with actual network data

                     // Simulate MCP AI analysis call
                     const mockAIResponse = await simulateMCPAnalysis();

                     aiData = mockAIResponse;
                     updateAIInterface();

                 } catch (error) {
                     console.error('Failed to fetch AI insights:', error);
                     showNotification('AI analysis temporarily unavailable', 'error');
                 } finally {
                     aiLoadingEl.style.display = 'none';
                 }
             }

             // Simulate MCP AI analysis (replace with actual MCP call)
             async function simulateMCPAnalysis() {
                 // In real implementation, this would be:
                 // const response = await fetch(`${MCP_SERVER_URL}/api/mcp/analyze_latency_ai`);
                 // return await response.json();

                 // For now, simulate based on current latency data
                 await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate API delay

                 // Calculate network score based on current devices
                 let totalLatency = 0;
                 let deviceCount = 0;
                 let onlineCount = 0;

                 for (const [name, history] of Object.entries(deviceHistory)) {
                     if (history.length > 0) {
                         const avg = history.reduce((a, b) => a + b, 0) / history.length;
                         totalLatency += avg;
                         deviceCount++;
                         onlineCount++;
                     }
                 }

                 const avgNetworkLatency = deviceCount > 0 ? totalLatency / deviceCount : 0;
                 let networkScore = 100;
                 let status = 'excellent';
                 const recommendations = [];

                 if (avgNetworkLatency > 100) {
                     networkScore -= 30;
                     status = 'warning';
                     recommendations.push('High latency detected - consider network optimization');
                 } else if (avgNetworkLatency > 50) {
                     networkScore -= 15;
                     status = 'good';
                     recommendations.push('Moderate latency - monitor for improvements');
                 }

                 if (onlineCount < 3) {
                     networkScore -= 10;
                     recommendations.push('Limited device visibility - consider adding more monitors');
                 }

                 if (recommendations.length === 0) {
                     recommendations.push('Network performance is optimal');
                     recommendations.push('All monitored devices showing good connectivity');
                 }

                 // Simulate platform discovery
                 const platforms = {
                     'LatencyMonitor': { url: 'http://192.168.4.129:8082', status: 'online' },
                     'CyphorLogs': { url: 'http://192.168.4.154:3000', status: 'online' },
                     'MCP Server': { url: 'http://192.168.4.154:8080', status: 'online' }
                 };

                 return {
                     ai_insights: {
                         network_score: Math.max(networkScore, 0),
                         status: status,
                         overall_avg_latency: avgNetworkLatency.toFixed(1),
                         performance_rating: avgNetworkLatency < 20 ? 'Excellent' :
                                           avgNetworkLatency < 50 ? 'Good' :
                                           avgNetworkLatency < 100 ? 'Fair' : 'Poor'
                     },
                     recommendations: recommendations,
                     platform_discovery: platforms
                 };
             }

             // Update AI interface
             function updateAIInterface() {
                 if (!aiData || !aiInsightsEnabled) return;

                 const insights = aiData.ai_insights;

                 // Update AI score
                 aiScoreEl.textContent = insights.network_score;
                 aiStatusEl.textContent = insights.status.toUpperCase();
                 aiStatusEl.className = `score-status ${insights.status}`;

                 // Update recommendations
                 aiRecommendationsEl.innerHTML = '';
                 aiData.recommendations.forEach(rec => {
                     const item = document.createElement('div');
                     item.className = 'recommendation-item';
                     item.innerHTML = `<i class="fas fa-lightbulb" style="color: var(--ai-glow); margin-right: 8px;"></i> ${rec}`;
                     aiRecommendationsEl.appendChild(item);
                 });

                 // Update platform status
                 platformStatusEl.innerHTML = '';
                 for (const [name, platform] of Object.entries(aiData.platform_discovery)) {
                     const item = document.createElement('div');
                     item.className = 'platform-item';
                     item.innerHTML = `
                         <div>
                             <div class="platform-name">${name}</div>
                             <div class="platform-url">${platform.url}</div>
                         </div>
                         <a href="${platform.url}" target="_blank" class="platform-link">
                             <i class="fas fa-external-link-alt"></i>
                         </a>
                     `;
                     platformStatusEl.appendChild(item);
                 }
             }

             // Delete device
             async function deleteDevice(name) {
                 if (!confirm(`Are you sure you want to delete ${name}?`)) return;

                 try {
                     const response = await fetch('/api/devices', {
                         method: 'DELETE',
                         headers: {
                             'Content-Type': 'application/json'
                         },
                         body: JSON.stringify({ name })
                     });

                     if (response.ok) {
                         showNotification(`${name} deleted successfully`);
                         delete deviceHistory[name];
                         updateData();
                     } else {
                         showNotification('Failed to delete device', 'error');
                     }
                 } catch (error) {
                     console.error('Error:', error);
                     showNotification('Network error', 'error');
                 }
             }

             // Update dashboard data (enhanced version)
             async function updateData() {
                 try {
                     const response = await fetch('/api/data');
                     const data = await response.json();

                     if (data.error) {
                         console.error(data.error);
                         return;
                     }

                     // Update timestamp
                     timestampEl.textContent = new Date(data.timestamp).toLocaleTimeString();

                     // Update device history
                     for (const [name, device] of Object.entries(data.devices)) {
                         if (!deviceHistory[name]) {
                             deviceHistory[name] = [];
                         }
                         if (device.reachable) {
                             deviceHistory[name].push(device.latency);
                             if (deviceHistory[name].length > HISTORY_POINTS) {
                                 deviceHistory[name].shift();
                             }
                         }
                     }

                     // Calculate stats
                     let totalDevices = 0;
                     let onlineDevices = 0;
                     let offlineDevices = 0;
                     let totalLatency = 0;
                     let latencyCount = 0;

                     // Clear container
                     devicesContainer.innerHTML = '';

                     // Create device cards (enhanced with AI)
                     for (const [name, device] of Object.entries(data.devices)) {
                         totalDevices++;
                         if (device.reachable) {
                             onlineDevices++;
                             totalLatency += device.latency;
                             latencyCount++;
                         } else {
                             offlineDevices++;
                         }

                         const card = document.createElement('div');
                         card.className = `device-card ${aiInsightsEnabled ? 'ai-enhanced' : ''}`;
                         card.innerHTML = `
                             <div class="device-header">
                                 <div>
                                     <div class="device-name">${name}</div>
                                     <div class="device-ip">${device.ip}</div>
                                 </div>
                                 <div class="device-actions">
                                     <button class="action-btn delete" onclick="deleteDevice('${name}')">
                                         <i class="fas fa-trash"></i>
                                     </button>
                                 </div>
                             </div>
                             <div class="status-indicator">
                                 <div class="status-dot ${device.reachable ? 'online' : 'offline'}"></div>
                                 <span>${device.reachable ? 'Online' : 'Offline'}</span>
                             </div>
                             ${device.reachable ? `
                                 <div class="latency-display">${device.latency.toFixed(1)} ms</div>
                                 <div class="latency-chart">
                                     ${createSparkline(deviceHistory[name] || [], name)}
                                 </div>
                                 ${createDeviceAIInsights(device, name)}
                             ` : '<div class="latency-display">-</div>'}
                         `;
                         devicesContainer.appendChild(card);
                     }

                     // Update stats
                     totalDevicesEl.textContent = totalDevices;
                     onlineDevicesEl.textContent = onlineDevices;
                     offlineDevicesEl.textContent = offlineDevices;
                     avgLatencyEl.textContent = latencyCount > 0 ? (totalLatency / latencyCount).toFixed(1) : '-';

                     // Update AI insights periodically
                     if (aiInsightsEnabled && Math.random() < 0.3) { // 30% chance to update AI on each refresh
                         fetchAIInsights();
                     }

                 } catch (error) {
                     console.error('Failed to fetch data:', error);
                     showNotification('Failed to fetch data', 'error');
                 }
             }

             // Handle device form submission
             document.getElementById('device-form').addEventListener('submit', async (e) => {
                 e.preventDefault();
                 const formData = new FormData(e.target);

                 try {
                     const response = await fetch('/api/devices', {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json'
                         },
                         body: JSON.stringify({
                             name: formData.get('name'),
                             ip: formData.get('ip')
                         })
                     });

                     if (response.ok) {
                         showNotification('Device added successfully!');
                         e.target.reset();
                         toggleAddDevice();
                         updateData();
                     } else {
                         showNotification('Failed to add device', 'error');
                     }
                 } catch (error) {
                     console.error('Error:', error);
                     showNotification('Network error', 'error');
                 }
             });

             // Auto-refresh with AI insights
             setInterval(() => {
                 if (autoRefresh) updateData();
             }, 2000);

             // Initial AI insights fetch
             setTimeout(() => {
                 fetchAIInsights();
             }, 3000); // Delay initial AI fetch to let devices load first

             // Initial load
             updateData();
         </script>
     </body>
     </html>
